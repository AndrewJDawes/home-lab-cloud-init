#cloud-config
autoinstall:
  version: 1
  identity:
    hostname: ubuntu-server
    password: $6$exDY1mhS4KUYCE/2$X06VbakcHcJMq6QlxF1xlWT02RHxk7y7P4xRZg9TxV6AozkdfLcOzatD9tXoJapLnFluczgCVaN4WoLE8PLHz.
    username: ubuntu
  storage:
    version: 1
    layout:
      name: zfs
    config:
      - id: disk-sda
        type: disk
        match:
          size: largest
        ptable: gpt
        preserve: false
        name: ""
        grub_device: true
      - id: partition-14
        type: partition
        device: disk-sda
        size: 4194304
        wipe: superblock
        flag: bios_grub
        number: 14
        preserve: false
        grub_device: false
      - id: partition-15
        type: partition
        device: disk-sda
        size: 111149056
        wipe: superblock
        flag: boot
        number: 15
        preserve: false
        grub_device: UEFI
      - id: partition-1
        type: partition
        device: disk-sda
        size: -1
        wipe: superblock
        number: 1
        preserve: false
        grub_device: false
      - id: format-15
        type: format
        fstype: fat32
        volume: partition-15
        preserve: false
      - id: mount-15
        type: mount
        path: /boot/efi
        device: format-15
      - id: format-1
        type: format
        fstype: zfsroot
        label: "cloudimg-rootfs"
        volume: partition-1
        preserve: false
      - id: mount-1
        type: mount
        path: /
        device: format-1
    early-commands:
      - |
        if [ -e "/sys/firmware/efi" ]; then
          sed -i -e "s/grub_device: UEFI/grub_device: true/" /autoinstall.yaml
        else
          sed -i -e "s/grub_device: UEFI/grub_device: false/" /autoinstall.yaml
        fi
        true
